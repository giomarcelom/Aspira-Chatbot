<script src="https://cdn.tailwindcss.com"></script>
<script>
  // Load Inter font for better aesthetics
  tailwind.config = {
    theme: {
      extend: {
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
        },
        colors: {
          'aspira-blue': '#1e40af',
          'aspira-light': '#eff6ff',
        }
      }
    }
  }
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  /* Custom scrollbar for better look */
  #chat-history::-webkit-scrollbar {
    width: 8px;
  }
  #chat-history::-webkit-scrollbar-thumb {
    background-color: #d1d5db;
    border-radius: 4px;
  }
  #chat-history {
    scrollbar-width: thin;
    scrollbar-color: #d1d5db transparent;
  }
  .chat-bubble {
      max-width: 85%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      word-wrap: break-word;
  }
  .disclaimer {
      font-size: 0.7rem;
      color: #6b7280;
      padding: 0.5rem;
      margin-top: 1rem;
      border-top: 1px solid #e5e7eb;
  }
</style>
<div id="app" class="flex flex-col h-full bg-white font-sans antialiased">
  <!-- Header -->
  <header class="p-4 bg-aspira-blue text-white rounded-t-xl shadow-md flex justify-between items-center">
    <h1 class="text-xl font-bold">Aspira Tax Assistant</h1>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
      <path d="M4.5 3.75a3 3 0 0 0-3 3v.75h21v-.75a3 3 0 0 0-3-3h-15ZM4.5 7.5a3 3 0 0 0-3 3v9c0 1.657 1.343 3 3 3h15a3 3 0 0 0 3-3v-9a3 3 0 0 0-3-3h-15Z" />
    </svg>
  </header>

  <!-- Chat History -->
  <main id="chat-history" class="flex-grow p-4 space-y-4 overflow-y-auto">
    <!-- Initial Bot Message -->
    <div class="flex justify-start">
      <div class="chat-bubble bg-gray-200 text-gray-800">
        Hello! I'm your Aspira Tax Assistant for Immigrants. I can help you understand U.S. tax residency, required forms like ITINs or SSNs, and common filing questions.
        <br><br>
        **To get started, please tell me your current immigration status (e.g., Green Card holder, H-1B Visa, F-1 Student, or recently arrived).**
      </div>
    </div>
  </main>

  <!-- Input and Footer -->
  <footer class="p-4 border-t border-gray-200">
    <!-- Loader -->
    <div id="loading-indicator" class="hidden text-center text-sm text-aspira-blue mb-2">
        Thinking...
    </div>
    <!-- Input Field -->
    <div class="flex space-x-2">
      <input
        type="text"
        id="user-input"
        placeholder="Ask a tax question..."
        class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-aspira-blue focus:border-aspira-blue transition duration-150"
        onkeydown="if(event.key === 'Enter') sendMessage()"
      />
      <button
        id="send-button"
        onclick="sendMessage()"
        class="bg-aspira-blue text-white p-3 rounded-lg shadow-md hover:bg-blue-800 transition duration-200 disabled:opacity-50"
      >
        Send
      </button>
    </div>
    <!-- Mandatory Disclaimer -->
    <p class="disclaimer">
      **Disclaimer:** I am an AI assistant, not a certified tax professional. The information provided here is for educational purposes only. Always consult a qualified CPA or tax attorney for official tax advice and filings.
    </p>
  </footer>
</div>

<script>
  // IMPORTANT: You must replace 'YOUR_API_KEY_HERE' below with your actual Gemini API key
  const apiKey = "AIzaSyB7V9sOK25fpXACDCRsZ7w4E6O9GL1oULw"; 
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
  const history = [
    {
        role: "system",
        parts: [{ text: "You are an expert, friendly, and supportive Tax Management Assistant for Immigrants in the United States. Your primary function is to provide clarity and context on complex U.S. tax topics specifically relevant to new residents, non-residents, and dual-status aliens. You MUST prioritize and explain concepts like tax residency tests (Green Card Test, Substantial Presence Test), the difference between SSN and ITIN, common filing forms (1040, 1040-NR), and the connection between tax compliance and immigration status (e.g., naturalization). Since this is a critical topic, you MUST use the Google Search tool for all queries to ensure the information is up-to-date and legally grounded. Keep responses concise and easy to understand. Every response must end with the mandatory disclaimer: 'Remember, I am an AI assistant, not a certified tax professional. Please consult a qualified CPA for official advice.'" }]
    }
  ];

  const chatHistory = document.getElementById('chat-history');
  const input = document.getElementById('user-input');
  const sendButton = document.getElementById('send-button');
  const loadingIndicator = document.getElementById('loading-indicator');

  function appendMessage(sender, text, sources = []) {
    const messageDiv = document.createElement('div');
    const bubble = document.createElement('div');
    bubble.classList.add('chat-bubble');

    if (sender === 'user') {
      messageDiv.classList.add('flex', 'justify-end');
      bubble.classList.add('bg-aspira-blue', 'text-white', 'rounded-br-none');
    } else {
      messageDiv.classList.add('flex', 'justify-start');
      bubble.classList.add('bg-gray-200', 'text-gray-800', 'rounded-tl-none');
    }

    // Convert markdown links (e.g., [Text](URL)) into clickable HTML links
    let formattedText = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (match, text, url) => {
        return `<a href="${url}" target="_blank" class="text-aspira-blue hover:text-blue-700 underline">${text}</a>`;
    });
    
    // Add sources as readable links
    if (sources.length > 0) {
        formattedText += '<div class="mt-2 pt-2 border-t border-gray-400 text-xs">';
        formattedText += '<p class="font-semibold">Sources:</p>';
        sources.forEach((source, index) => {
            formattedText += `<p>${index + 1}. <a href="${source.uri}" target="_blank" class="text-aspira-blue hover:text-blue-700 underline">${source.title || source.uri}</a></p>`;
        });
        formattedText += '</div>';
    }

    bubble.innerHTML = formattedText;
    messageDiv.appendChild(bubble);
    chatHistory.appendChild(messageDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
  }

  function toggleUI(disabled) {
      input.disabled = disabled;
      sendButton.disabled = disabled;
      loadingIndicator.classList.toggle('hidden', !disabled);
  }

  function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function fetchWithRetry(url, options, retries = 3) {
      for (let i = 0; i < retries; i++) {
          try {
              const response = await fetch(url, options);
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              return response;
          } catch (error) {
              console.error(`Attempt ${i + 1} failed:`, error);
              if (i === retries - 1) throw error;
              const delayTime = Math.pow(2, i) * 1000 + Math.random() * 1000;
              await delay(delayTime);
          }
      }
  }

  async function sendMessage() {
    const userText = input.value.trim();
    if (userText === '') return;

    appendMessage('user', userText);
    history.push({ role: 'user', parts: [{ text: userText }] });
    input.value = '';
    toggleUI(true);

    try {
      const payload = {
        contents: history.filter(item => item.role !== 'system'), // only send user/model history
        tools: [{ "google_search": {} }],
        systemInstruction: history.find(item => item.role === 'system').parts[0],
      };

      const response = await fetchWithRetry(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const result = await response.json();
      const candidate = result.candidates?.[0];
      let botText = "Sorry, I encountered an issue fetching the tax information.";
      let sources = [];

      if (candidate && candidate.content?.parts?.[0]?.text) {
        botText = candidate.content.parts[0].text;

        // Extract grounding sources
        const groundingMetadata = candidate.groundingMetadata;
        if (groundingMetadata && groundingMetadata.groundingAttributions) {
            sources = groundingMetadata.groundingAttributions
                .map(attribution => ({
                    uri: attribution.web?.uri,
                    title: attribution.web?.title,
                }))
                .filter(source => source.uri && source.title);
        }
      }

      appendMessage('bot', botText, sources);
      history.push({ role: 'model', parts: [{ text: botText }] });

    } catch (error) {
      console.error('API Error:', error);
      appendMessage('bot', "I'm sorry, I'm having trouble connecting to the tax information service right now. Please try again in a moment.");
      history.push({ role: 'model', parts: [{ text: "I'm sorry, I'm having trouble connecting to the tax information service right now. Please try again in a moment." }] });
    } finally {
      toggleUI(false);
    }
  }
</script>
